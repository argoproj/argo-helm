{{- define "workflow-rb-base" }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
{{- end }}

{{- define "workflow-rb-roleref" }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
{{- end }}

{{- define "workflow-rb-subjects" }}
subjects:
  - kind: ServiceAccount
{{- end }}

{{- if .Values.workflow.rbac.create -}}
  {{- range $namespace := append .Values.controller.workflowNamespaces .Values.workflow.namespace | compact | uniq }}

    {{ include "workflow-rb-base" . }}
  name: {{ "argo-workflows.fullname" }}-workflow
  namespace: {{ $namespace }}

    {{- include "workflow-rb-roleref" . }}
  name: {{ template "argo-workflows.fullname" $ }}-workflow

    {{- include "workflow-rb-subjects" . }}
    name: {{ $.Values.workflow.serviceAccount.name }}
    namespace: {{ $namespace }}
  {{- end }}

{{- end }}
