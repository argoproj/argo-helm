{{- define "sa-base" }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
{{- end }}

{{- if .Values.workflow.serviceAccount.create -}}

  {{- /*
      Cardinality-check the namespaces/namespace variables
      This type check is done only once, here. It would be overkill to perform it for other RBAC resources as well.
  */}}

  {{- if and .Values.workflow.namespaces .Values.workflow.namespace }}
    {{- fail "Please set either workflow.namespaces or workflow.namespace for the service account, not both" }}
  {{- end }}

  {{- if .Values.workflow.namespaces }}

    {{- /*
      Type-check the namespaces variable for being a list ("slice")
      This type check is done only once, here. It would be overkill to perform it for other RBAC resources as well.
    */}}
    {{- if not ( kindIs "slice" .Values.workflow.namespaces ) }}
      {{- fail ( printf "workflow.namespaces is a slice, got %s %s" ( kindOf .Values.workflow.namespaces ) .Values.workflow.namespaces ) }}
    {{- end }}

    {{ $namespaces := .Values.workflow.namespaces }}
    {{- range $namespaces }}
      {{ $namespace := . }}
      {{ include "sa-base" . }}
  name: {{ $.Values.workflow.serviceAccount.name }}
  namespace: {{ $namespace }}
  annotations:
      {{- toYaml $.Values.workflow.serviceAccount.annotations | nindent 4 }}
    {{- end }}

  {{- else }}

    {{- /*
      The namespace will default to "argo" if neither "namespaces" nor "namespace" is set
    */}}
    {{ include "sa-base" . }}
  name: {{ $.Values.workflow.serviceAccount.name }}
  namespace: {{ .Values.workflow.namespace | default "argo" }}
  annotations:
    {{- toYaml $.Values.workflow.serviceAccount.annotations | nindent 4 }}
  {{- end }}

{{- end }}
