version: 2.1
jobs:
  lint:
    docker:
      - image: gcr.io/kubernetes-charts-ci/test-image:v3.0.1
    steps:
      - checkout
      - run: ct lint --config .circleci/chart-testing.yaml --lint-conf .circleci/lintconf.yaml
  test:
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run: | # Required to drop files from repo into test image
          docker create -v /app/test --name test_sources alpine:3.4 /bin/true
          docker cp charts test_sources:/app/test
          docker run --name terratest --volumes-from test_sources seanson/terratest-helm-tester:latest
          docker cp terratest:/app/out ./test_results
      - store_artifacts:
          path: ./test_results
      - store_test_results:
          path: ./test_results

  # Technically this only needs to be run on master, but it's good to have it run on every PR
  # so that it is regularly tested.
  publish:
    docker:
      # We just need an image with `helm` on it. Handily we know of one already.
      - image: gcr.io/kubernetes-charts-ci/test-image:v3.0.1
    steps:
      # install the additional keys needed to push to Github. Alex Collins owns these keys.
      - add_ssh_keys
      - run: git config --global user.email "nobody@circleci.com"
      - run: git config --global user.name "Circle CI Build"
      - checkout
      - run: helm init --client-only
      # Only actually publish charts on master.
      - run: |
          set -x
          if [ "$CIRCLE_BRANCH" = "master" ]; then
            export GIT_PUSH=true
          else
            export GIT_PUSH=false
          fi
          sh ./scripts/publish.sh
workflows:
  version: 2
  workflow:
    jobs:
      - lint
      - test
      - publish:
          requires:
            - lint
